/**
 * Google Apps Script - ä¿¡ä»°ä¸ç†æ€§æµ‹éªŒæ•°æ®å¤„ç† (ä¼˜åŒ–ç‰ˆ)
 * 
 * åŠŸèƒ½ï¼š
 * 1. æ¥æ”¶æµ‹éªŒç»“æœæ•°æ®
 * 2. ä¿å­˜åˆ° Google Sheetsï¼ˆä»…æ±‡æ€»æ•°æ®ï¼‰
 * 3. å¦‚æœç”¨æˆ·æä¾›é‚®ç®±ï¼Œå‘é€è¯¦ç»†æµ‹è¯•æŠ¥å‘Š
 * 
 * æ”¹è¿›è¯´æ˜ï¼š
 * - ä½¿ç”¨çº¯è¡¨æ ¼å¸ƒå±€ï¼Œç¡®ä¿ Outlook å…¼å®¹æ€§
 * - ç§»é™¤ CSS Grid å’Œæ¸å˜èƒŒæ™¯
 * - æ‰€æœ‰æ ·å¼éƒ½é‡‡ç”¨å†…è”æ–¹å¼
 * - ç®€åŒ– HTML ç»“æ„ï¼Œæå‡è·¨å¹³å°å…¼å®¹æ€§
 * 
 * éƒ¨ç½²è¯´æ˜ï¼š
 * 1. åœ¨ Google Apps Script ä¸­åˆ›å»ºæ–°é¡¹ç›®
 * 2. å¤åˆ¶æ­¤ä»£ç 
 * 3. åˆ›å»ºä¸€ä¸ª Google Sheetï¼Œå‘½åä¸º"æµ‹éªŒç»“æœ"
 * 4. éƒ¨ç½²ä¸º Web åº”ç”¨ï¼ˆæ‰§è¡Œèº«ä»½ï¼šæˆ‘ï¼Œè®¿é—®æƒé™ï¼šä»»ä½•äººï¼‰
 * 5. å¤åˆ¶éƒ¨ç½²çš„ URL åˆ° index.html ä¸­
 */

// é…ç½®åŒºåŸŸ
const SHEET_NAME = 'æµ‹éªŒç»“æœ';

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°é‚®ç®±åœ°å€
    if (data.æ›´æ–°é‚®ç®± === true) {
      // æ›´æ–°åŸè®°å½•çš„é‚®ç®±å­—æ®µå¹¶å‘é€é‚®ä»¶
      updateEmailInSheet(data);
      if (data.é‚®ç®±åœ°å€) {
        sendEmailReport(data);
      }
      return ContentService.createTextOutput(JSON.stringify({
        status: 'success',
        message: 'é‚®ç®±å·²æ›´æ–°ï¼Œé‚®ä»¶å·²å‘é€'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // æ­£å¸¸æµç¨‹ï¼šä¿å­˜æ–°è®°å½•åˆ°è¡¨æ ¼
    saveToSheet(data);
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      message: 'æ•°æ®å·²ä¿å­˜'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('é”™è¯¯: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function saveToSheet(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAME);
  
  // å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    // æ·»åŠ è¡¨å¤´
    sheet.appendRow([
      'æ—¶é—´æˆ³', 'äººæ ¼ç±»å‹', 'ä¿¡ä»°åˆ†æ•°', 'ç†æ™ºåˆ†æ•°', 
      'æŠ˜è¡·åˆ†æ•°', 'å®¿å‘½åˆ†æ•°', 'æ€»é¢˜æ•°', 'é‚®ç®±åœ°å€'
    ]);
    // å†»ç»“è¡¨å¤´
    sheet.setFrozenRows(1);
    // æ ¼å¼åŒ–è¡¨å¤´
    const headerRange = sheet.getRange(1, 1, 1, 8);
    headerRange.setBackground('#667eea');
    headerRange.setFontColor('#ffffff');
    headerRange.setFontWeight('bold');
    headerRange.setHorizontalAlignment('center');
  }
  
  // æ·»åŠ æ•°æ®è¡Œ
  sheet.appendRow([
    data.æ—¶é—´æˆ³ || new Date().toLocaleString('zh-CN'),
    data.äººæ ¼ç±»å‹ || '',
    data.ä¿¡ä»°åˆ†æ•° || 0,
    data.ç†æ™ºåˆ†æ•° || 0,
    data.æŠ˜è¡·åˆ†æ•° || 0,
    data.å®¿å‘½åˆ†æ•° || 0,
    data.æ€»é¢˜æ•° || 0,
    data.é‚®ç®±åœ°å€ || 'æœªæä¾›'
  ]);
  
  // è‡ªåŠ¨è°ƒæ•´åˆ—å®½
  sheet.autoResizeColumns(1, 8);
}

function updateEmailInSheet(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  
  if (!sheet) {
    Logger.log('æ‰¾ä¸åˆ°å·¥ä½œè¡¨');
    return;
  }
  
  // è·å–æœ€åä¸€è¡Œæ•°æ®çš„è¡Œå·
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) {
    Logger.log('æ²¡æœ‰æ•°æ®éœ€è¦æ›´æ–°');
    return;
  }
  
  // æ£€æŸ¥æœ€åä¸€è¡Œçš„æ•°æ®ï¼Œç¡®è®¤æ˜¯å¦éœ€è¦æ›´æ–°
  const lastRowData = sheet.getRange(lastRow, 1, 1, 8).getValues()[0];
  const lastTimestamp = lastRowData[0];
  const lastPersonality = lastRowData[1];
  const lastEmail = lastRowData[7];
  
  Logger.log('æœ€åä¸€è¡Œæ•°æ®ï¼š');
  Logger.log('æ—¶é—´æˆ³: ' + lastTimestamp);
  Logger.log('äººæ ¼ç±»å‹: ' + lastPersonality);
  Logger.log('å½“å‰é‚®ç®±: ' + lastEmail);
  
  // æ£€æŸ¥äººæ ¼ç±»å‹æ˜¯å¦åŒ¹é…ï¼ˆå¢åŠ å¯é æ€§ï¼‰
  if (lastPersonality === data.äººæ ¼ç±»å‹ && 
      (lastEmail === 'æœªæä¾›' || lastEmail === '' || lastEmail === null)) {
    // æ›´æ–°æœ€åä¸€è¡Œçš„é‚®ç®±åœ°å€
    sheet.getRange(lastRow, 8).setValue(data.é‚®ç®±åœ°å€);
    Logger.log('âœ… å·²æ›´æ–°ç¬¬ ' + lastRow + ' è¡Œçš„é‚®ç®±åœ°å€ä¸º: ' + data.é‚®ç®±åœ°å€);
  } else {
    Logger.log('âš ï¸ æ— æ³•ç¡®è®¤æ˜¯å¦ä¸ºåŒä¸€è®°å½•ï¼Œæœªæ›´æ–°');
    Logger.log('è¯·æ±‚çš„äººæ ¼ç±»å‹: ' + data.äººæ ¼ç±»å‹);
  }
}

function sendEmailReport(data) {
  const email = data.é‚®ç®±åœ°å€;
  if (!email) return;
  
  // æ„å»ºé‚®ä»¶ä¸»é¢˜
  const subject = `ğŸ¯ æ‚¨çš„ä¿¡ä»°ä¸ç†æ€§æµ‹éªŒç»“æœ - ${data.äººæ ¼ç±»å‹}`;
  
  // æ„å»ºé‚®ä»¶æ­£æ–‡ - ä½¿ç”¨è¡¨æ ¼å¸ƒå±€ï¼Œç¡®ä¿è·¨å¹³å°å…¼å®¹
  let htmlBody = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
      <!-- å¤–å±‚å®¹å™¨è¡¨æ ¼ -->
      <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f5f5f5; padding: 20px 0;">
        <tr>
          <td align="center">
            <!-- ä¸»å†…å®¹è¡¨æ ¼ -->
            <table width="600" cellpadding="0" cellspacing="0" border="0" style="background-color: #ffffff; max-width: 600px;">
              
              <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ -->
              <tr>
                <td style="background-color: #667eea; padding: 30px 20px; text-align: center;">
                  <h1 style="margin: 0; font-size: 24px; color: #ffffff; font-weight: bold;">ğŸ‰ ä¿¡ä»°ä¸ç†æ€§æµ‹éªŒç»“æœæŠ¥å‘Š</h1>
                  <p style="margin: 10px 0 0 0; font-size: 14px; color: #ffffff;">${data.æ—¶é—´æˆ³}</p>
                </td>
              </tr>
              
              <!-- ç»“æœæ€»è§ˆåŒºåŸŸ -->
              <tr>
                <td style="padding: 30px 20px; background-color: #ffffff;">
                  <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #667eea;">ğŸ“Š æ‚¨çš„æµ‹éªŒç»“æœ</h2>
                  
                  <!-- äººæ ¼ç±»å‹è¯´æ˜ -->
                  <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #fff9e6; border-left: 4px solid #ffc107; margin-bottom: 25px;">
                    <tr>
                      <td style="padding: 15px;">
                        <p style="margin: 0; font-size: 16px; color: #333333; font-weight: bold;">${data.äººæ ¼ç±»å‹}</p>
                        <p style="margin: 8px 0 0 0; font-size: 14px; color: #666666; line-height: 1.6;">${data.äººæ ¼è§£é‡Š || ''}</p>
                      </td>
                    </tr>
                  </table>
                  
                  <!-- åˆ†æ•°è¡¨æ ¼ - 2x2 ç½‘æ ¼ -->
                  <table width="100%" cellpadding="0" cellspacing="0" border="0">
                    <tr>
                      <!-- ä¿¡ä»°æˆåˆ† -->
                      <td width="48%" style="background-color: #667eea; padding: 20px; text-align: center; vertical-align: top;">
                        <p style="margin: 0; font-size: 14px; color: #ffffff;">ä¿¡ä»°æˆåˆ†</p>
                        <p style="margin: 10px 0 0 0; font-size: 32px; color: #ffffff; font-weight: bold;">${data.ä¿¡ä»°åˆ†æ•°}</p>
                      </td>
                      <td width="4%"></td>
                      <!-- ç†æ™ºæˆåˆ† -->
                      <td width="48%" style="background-color: #667eea; padding: 20px; text-align: center; vertical-align: top;">
                        <p style="margin: 0; font-size: 14px; color: #ffffff;">ç†æ™ºæˆåˆ†</p>
                        <p style="margin: 10px 0 0 0; font-size: 32px; color: #ffffff; font-weight: bold;">${data.ç†æ™ºåˆ†æ•°}</p>
                      </td>
                    </tr>
                    <tr><td colspan="3" height="15"></td></tr>
                    <tr>
                      <!-- æŠ˜è¡·æˆåˆ† -->
                      <td width="48%" style="background-color: #764ba2; padding: 20px; text-align: center; vertical-align: top;">
                        <p style="margin: 0; font-size: 14px; color: #ffffff;">æŠ˜è¡·æˆåˆ†</p>
                        <p style="margin: 10px 0 0 0; font-size: 32px; color: #ffffff; font-weight: bold;">${data.æŠ˜è¡·åˆ†æ•°}</p>
                      </td>
                      <td width="4%"></td>
                      <!-- å®¿å‘½æˆåˆ† -->
                      <td width="48%" style="background-color: #764ba2; padding: 20px; text-align: center; vertical-align: top;">
                        <p style="margin: 0; font-size: 14px; color: #ffffff;">å®¿å‘½æˆåˆ†</p>
                        <p style="margin: 10px 0 0 0; font-size: 32px; color: #ffffff; font-weight: bold;">${data.å®¿å‘½åˆ†æ•°}</p>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
              
              <!-- è¯¦ç»†ç­”é¢˜è®°å½•æ ‡é¢˜ -->
              <tr>
                <td style="padding: 0 20px 20px 20px; background-color: #ffffff;">
                  <h2 style="margin: 20px 0 10px 0; font-size: 20px; color: #667eea;">ğŸ“ è¯¦ç»†ç­”é¢˜è®°å½•</h2>
                  <p style="margin: 0; font-size: 14px; color: #666666;">ä»¥ä¸‹æ˜¯æ‚¨çš„æ¯é“é¢˜ç›®çš„ç­”æ¡ˆå’Œå¯¹åº”çš„äººæ ¼åˆ†ç±»</p>
                </td>
              </tr>
  `;
  
  // æ·»åŠ è¯¦ç»†ç­”é¢˜è®°å½•
  if (data.è¯¦ç»†ç­”é¢˜ && Array.isArray(data.è¯¦ç»†ç­”é¢˜)) {
    data.è¯¦ç»†ç­”é¢˜.forEach(item => {
      htmlBody += `
              <!-- é—®é¢˜é¡¹ -->
              <tr>
                <td style="padding: 0 20px 15px 20px; background-color: #ffffff;">
                  <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f9f9f9; border-left: 4px solid #667eea;">
                    <tr>
                      <td style="padding: 15px;">
                        <p style="margin: 0 0 8px 0; font-size: 14px; color: #667eea; font-weight: bold;">é—®é¢˜ ${item.é¢˜å·}</p>
                        <p style="margin: 0 0 12px 0; font-size: 15px; color: #333333; font-weight: 500; line-height: 1.5;">${item.é—®é¢˜}</p>
                        <p style="margin: 0 0 8px 0; font-size: 14px; color: #666666;">âœ“ æ‚¨çš„ç­”æ¡ˆï¼š${item.ç­”æ¡ˆ}</p>
                        <table cellpadding="0" cellspacing="0" border="0">
                          <tr>
                            <td style="background-color: #764ba2; padding: 6px 12px; font-size: 13px; color: #ffffff;">â†’ ${item.åˆ†ç±»}</td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
      `;
    });
  }
  
  htmlBody += `
              <!-- é¡µè„š -->
              <tr>
                <td style="padding: 30px 20px; background-color: #ffffff; border-top: 1px solid #e0e0e0; text-align: center;">
                  <p style="margin: 0; font-size: 14px; color: #666666;">æ„Ÿè°¢æ‚¨å‚ä¸ä¿¡ä»°ä¸ç†æ€§æµ‹éªŒï¼</p>
                  <p style="margin: 10px 0 0 0; font-size: 12px; color: #999999;">æ­¤é‚®ä»¶ç”±ç³»ç»Ÿè‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿ç›´æ¥å›å¤</p>
                </td>
              </tr>
              
            </table>
          </td>
        </tr>
      </table>
    </body>
    </html>
  `;
  
  // å‘é€é‚®ä»¶
  try {
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: htmlBody
    });
    Logger.log('é‚®ä»¶å·²å‘é€åˆ°: ' + email);
  } catch (error) {
    Logger.log('é‚®ä»¶å‘é€å¤±è´¥: ' + error.toString());
  }
}

// æµ‹è¯•å‡½æ•°
function testEmail() {
  const testData = {
    æ—¶é—´æˆ³: new Date().toLocaleString('zh-CN'),
    äººæ ¼ç±»å‹: 'æŠ˜è¡·å‹',
    ä¿¡ä»°åˆ†æ•°: 8,
    ç†æ™ºåˆ†æ•°: 10,
    æŠ˜è¡·åˆ†æ•°: 9,
    å®¿å‘½åˆ†æ•°: 3,
    æ€»é¢˜æ•°: 30,
    é‚®ç®±åœ°å€: 'test@example.com', // æ”¹æˆä½ çš„æµ‹è¯•é‚®ç®±
    äººæ ¼è§£é‡Š: 'ä½ å€¾å‘æŠ˜è¡·å‹ï¼šä¿¡ä»°ä¸ç†æ™ºå…¼é¡¾ï¼Œæ—¢å°Šé‡ä¼ ç»Ÿï¼Œä¹Ÿé‡è§†ç°å®ã€‚',
    è¯¦ç»†ç­”é¢˜: [
      {
        é¢˜å·: 1,
        é—®é¢˜: 'å¦‚æœæœ‰äººè¯´ï¼šæ‹œä¸‰æ‹œï¼Œè´¢ç¥å°±ä¼šçœ·é¡¾ä½ ã€‚ä½ çš„ç¬¬ä¸€æ„Ÿè§‰æ˜¯ï¼Ÿ',
        ç­”æ¡ˆ: 'ä¸å¦¨è¯•è¯•çœ‹ï¼Œä¹Ÿè®¸æœ‰ç”¨',
        åˆ†ç±»: 'æŠ˜è¡·å‹'
      },
      {
        é¢˜å·: 2,
        é—®é¢˜: 'è¿‡å¹´æ—¶äº²å‹æ‹‰ä½ å»æ‹œè´¢ç¥ï¼Œä½ ä¼šï¼š',
        ç­”æ¡ˆ: 'è·Ÿç€å»ï¼Œå°Šé‡ä¹ ä¿—',
        åˆ†ç±»: 'æŠ˜è¡·å‹'
      }
    ]
  };
  
  sendEmailReport(testData);
}
